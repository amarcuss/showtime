# CLAUDE.md

Project context for Claude Code sessions.

## What This Project Is

Showtime is an interactive graph explorer for movies and TV shows. 290 titles are rendered as poster-image tiles on a 2D canvas, connected by relationship edges (shared actors, directors, franchises, etc). The layout is precomputed offline via D3 force simulation; the frontend only renders and animates.

## Commands

```bash
npm run dev          # Start Vite dev server (localhost:5173)
npm run build        # TypeScript check + Vite production build
npm run lint         # ESLint
npm run validate     # Data integrity checks (npx tsx scripts/validate-data.ts)
```

## Architecture Overview

### Data Pipeline (offline scripts)

The data pipeline runs in order:

1. **`scripts/gen-edges.mjs`** — curated relationships (franchises, director clusters, actor groups)
2. **`scripts/gen-edges-extra.mjs`** — auto-generated connections (shared cast/director, genre overlap for under-connected nodes)
3. **`scripts/gen-layout.mjs`** — community detection (label propagation) + D3 force simulation → `layout.json`
4. **`scripts/fetch-posters.mjs`** — TMDB poster downloads → `public/posters/`, updates `posterUrl` in `nodes.json`

After changing edges, you must re-run `gen-layout.mjs` to regenerate positions. After changing nodes, re-run `fetch-posters.mjs` for new posters.

### Frontend Architecture

```
App.tsx
├── GraphCanvas (full-screen canvas)
│   ├── nodeRenderer.ts    — paints each tile (poster image or gradient fallback)
│   ├── linkRenderer.ts    — paints each edge (color-coded, labels on hover)
│   └── useGraphInteraction.ts — click/hover handlers, camera control
├── SearchBar              — fuzzy search with dropdown
├── GenreFilter            — toggle pills
├── RelationshipFilter     — toggle pills
├── ViewControls           — zoom +/-, reset
├── Breadcrumbs            — navigation history
└── DetailPanel            — slide-in metadata + connections
```

**State:** Single Zustand store (`src/store/useGraphStore.ts`) holds all nodes, edges, layout positions, selection, filters, and navigation history.

**Rendering:** react-force-graph-2d with custom `nodeCanvasObject` and `linkCanvasObject`. Nodes use fixed positions from `layout.json` (no runtime force simulation). Positions are overridden by `useLayoutAnimation` during selection animations.

**Image loading:** `useImageCache` preloads all poster images and exposes `loadedCount` — a state counter that increments in batches as images finish loading, causing the canvas to re-render and show newly available posters.

### Key Rendering Details

- **Node tiles:** 120x190px (NODE_WIDTH x NODE_HEIGHT). Top 140px = poster image (clipped to rounded top corners). Bottom 50px = title + genre/year.
- **Zoomed-out mode:** When `globalScale < 0.6`, tiles switch to small colored dots with text labels. Posters are not drawn.
- **Auto-drift:** When no node is selected, the camera slowly pans with bounce-off-edge behavior. Killed immediately on any `pointerdown` via a ref flag (not React state) to avoid race conditions with click handlers.
- **Selection animation:** `useLayoutAnimation` arranges neighbors in a 200px radius circle around the selected node, pushes non-neighbors outside a 360px zone (NEIGHBOR_RADIUS + PUSH_CLEARANCE), animates over 500ms with easeInOutCubic.

### Layout Tuning

The main layout parameter is `forceCollide(210)` in `gen-layout.mjs`. Increasing this value spreads tiles further apart. After changing, re-run:

```bash
node scripts/gen-layout.mjs
```

Related parameter: `PUSH_CLEARANCE = 160` in `useLayoutAnimation.ts` controls how far non-neighbor tiles are pushed during selection animation.

## Important Patterns

- **All hooks must be called before the `if (isLoading)` early return** in `GraphCanvas.tsx`. Placing a hook after causes React error #310 in production builds.
- **The link renderer uses `RuntimeLink` type** (with `Omit<ContentEdge, "source" | "target">`) because react-force-graph-2d mutates `source`/`target` from strings to objects at runtime.
- **The TMDB API key is v3** (passed as `?api_key=` query parameter), not v4 (Bearer token). The fetch-posters script handles this.
- **WALL-E requires searching "WALL·E"** (with middle dot) on TMDB. The script doesn't handle this automatically — it was downloaded manually.
- **Poster images are committed to git.** No TMDB key is needed at build/deploy time.

## Data Files

| File | Content | Regenerated by |
|------|---------|----------------|
| `public/data/nodes.json` | 290 titles with metadata + posterUrl | Manual + fetch-posters.mjs |
| `public/data/edges.json` | ~800 relationships | gen-edges.mjs + gen-edges-extra.mjs |
| `public/data/layout.json` | x/y positions + community IDs | gen-layout.mjs |
| `public/posters/*.jpg` | 290 poster thumbnails (w154) | fetch-posters.mjs |

## Color Systems

- **Genre colors** (`src/utils/colors.ts`): 21 genres mapped to specific colors. First genre determines node border color.
- **Edge colors** (`src/utils/colors.ts`): 10 relationship types each have a color. Used for highlighted edges and filter pills.

## Common Tasks

**Add a new title:**
1. Add entry to `public/data/nodes.json`
2. Run `node scripts/gen-edges-extra.mjs` to auto-connect it
3. Run `node scripts/gen-layout.mjs` to recompute positions
4. Run `TMDB_API_KEY=<key> node scripts/fetch-posters.mjs` to download its poster
5. Run `npm run validate` to check data integrity

**Adjust tile spacing:**
Edit `forceCollide(210)` in `scripts/gen-layout.mjs`, then `node scripts/gen-layout.mjs`.

**Change tile dimensions:**
Update `NODE_WIDTH`, `NODE_HEIGHT`, `POSTER_HEIGHT`, `TEXT_HEIGHT` in `src/components/Graph/nodeRenderer.ts`. Also update `forceCollide` in `gen-layout.mjs` and `PUSH_CLEARANCE` in `useLayoutAnimation.ts` to match.
